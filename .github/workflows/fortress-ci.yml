name: Fortress CI - Security & Compliance

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  # Job 1: Static Analysis & Security
  security_scan:
    name: Security Scan (Trivy & Checkov)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy (S3 Config Scan)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          exit-code: '1' # Fail the build if high-risk S3 issues found
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Run Checkov (Compliance Baseline)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/modules
          framework: terraform
          soft_fail: false # Hard fail on compliance breaches

  # Job 2: Logic Validation (The "Proof of Work")
  validation:
    name: Fortress Logic Validation
    runs-on: ubuntu-latest
    needs: security_scan
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Validate Module Logic
        run: |
          for dir in terraform/modules/*; do
            echo "Validating $dir..."
            cd $dir && terraform init -backend=false && terraform validate && cd -
          done


